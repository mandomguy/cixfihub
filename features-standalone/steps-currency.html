<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>POE2 Currency Tracker</title>
  <style>
    /* ==== Reset & Base ==== */
    *, *::before, *::after { box-sizing: border-box; margin:0; padding:0; }
    body { 
      font-family: system-ui, -apple-system, sans-serif;
      background: #0f0f17;
      color: #e0e0ff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background-image: 
        radial-gradient(circle at 10% -10%, rgba(130, 90, 230, 0.25) 0%, transparent 60%),
        radial-gradient(circle at 90% -20%, rgba(30, 200, 190, 0.25) 0%, transparent 60%),
        #0f0f17;
    }
    button { border:none; background:none; cursor:pointer; }
    img { vertical-align:middle; }

    /* ==== Layout ==== */
    .container {
      width: 95%;
      max-width: 500px;
      background: rgba(20, 20, 40, 0.6);
      backdrop-filter: blur(16px);
      border-radius: 24px;
      border: 1px solid rgba(130, 90, 230, 0.3);
      overflow: hidden;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    }
    .header {
      padding: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .ref-btn {
      padding: 8px 16px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }
    .ref-btn.active { background:#825ae6; color:#fff; }
    .ref-btn:not(.active) { background:rgba(255,255,255,0.08); color:#aaa; }
    .refresh-btn {
      width:40px; height:40px;
      border-radius:50%;
      background:rgba(255,255,255,0.08);
      display:flex; align-items:center; justify-content:center;
    }

    .periods {
      display:flex; gap:8px; padding:16px 20px;
    }
    .period-btn {
      flex:1;
      padding:10px;
      border-radius:12px;
      font-size:14px;
      font-weight:600;
      transition:all 0.3s;
    }
    .period-btn.active { background:#825ae6; color:#fff; box-shadow:0 8px 20px rgba(130,90,230,0.4); }
    .period-btn:not(.active) { background:rgba(255,255,255,0.08); color:#aaa; }

    .content { min-height:340px; padding:20px; position:relative; }
    .fade-in { animation:fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:none;} }

    /* ==== Chart View ==== */
    .chart-header {
      display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;
    }
    .chart-title {
      display:flex; align-items:center; gap:12px;
    }
    .chart-title img { width:48px; height:48px; border-radius:50%; }
    .chart-title h2 { font-size:20px; }
    .chart-price { font-size:28px; font-weight:800; color:#825ae6; }
    .change-badge {
      padding:6px 12px;
      border-radius:50px;
      font-size:13px;
      font-weight:600;
    }
    .positive { background:rgba(34,197,94,0.2); color:#34c97a; }
    .negative { background:rgba(239,68,68,0.2); color:#ef4444; }

    /* ==== Prices View ==== */
    .price-list { max-height:400px; overflow-y:auto; padding-right:8px; }
    .price-card {
      background:rgba(30,30,60,0.4);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:16px;
      padding:16px;
      margin-bottom:12px;
      transition:all 0.3s;
      position:relative;
      overflow:hidden;
    }
    .price-card:hover { background:rgba(40,40,80,0.6); border-color:rgba(130,90,230,0.4); }
    .price-card.selected { border-color:#825ae6; background:rgba(130,90,230,0.15); box-shadow:0 0 20px rgba(130,90,230,0.3); }
    .price-row { display:flex; align-items:center; justify-content:space-between; }
    .price-info { display:flex; align-items:center; gap:12px; }
    .price-info img { width:36px; height:36px; border-radius:50%; }
    .price-name { font-weight:600; }
    .price-val { font-size:13px; color:#aaa; }

    /* ==== Compare View ==== */
    .compare-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(140px,1fr));
      gap:12px;
      max-height:400px;
      overflow-y:auto;
    }
    .compare-card {
      background:rgba(30,30,60,0.4);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:16px;
      padding:14px;
      transition:all 0.3s;
    }
    .compare-card:hover { background:rgba(40,40,80,0.6); }
    .compare-name { display:flex; align-items:center; gap:8px; font-size:13px; margin-bottom:8px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    .compare-name img { width:24px; height:24px; border-radius:50%; }
    .compare-price { font-size:18px; font-weight:800; color:#825ae6; }
    .compare-changes { display:grid; grid-template-columns:1fr 1fr; gap:4px; font-size:11px; margin-top:8px; }

    /* ==== History View ==== */
    .history-list { max-height:340px; overflow-y:auto; }
    .history-item {
      display:flex; justify-content:space-between; padding:12px 16px;
      background:rgba(30,30,60,0.3);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:12px;
      margin-bottom:8px;
      font-size:14px;
    }

    /* ==== Bottom Navigation ==== */
    .bottom-nav {
      display:flex;
      background:rgba(20,20,40,0.7);
      backdrop-filter:blur(12px);
      border-top:1px solid rgba(255,255,255,0.08);
    }
    .nav-item {
      flex:1;
      padding:16px 0;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
      color:#888;
      transition:all 0.3s;
      position:relative;
    }
    .nav-item.active { color:#825ae6; }
    .nav-item svg { width:24px; height:24px; transition:transform 0.3s; }
    .nav-item.active svg { transform:scale(1.15); }
    .nav-item span { font-size:11px; font-weight:600; }
    .indicator {
      position:absolute;
      bottom:0;
      left:50%;
      transform:translateX(-50%);
      width:48px;
      height:2px;
      background:#825ae6;
      border-radius:2px;
    }

    /* Scrollbar */
    ::-webkit-scrollbar { width:6px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.2); border-radius:3px; }
  </style>
</head>
<body>

<div class="container" id="app">
  <!-- Header -->
  <div class="header">
    <div>
      <button class="ref-btn" id="chaosBtn">Chaos</button>
      <button class="ref-btn" id="exaltedBtn">Exalted</button>
    </div>
    <button class="refresh-btn" id="refreshBtn">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
    </button>
  </div>

  <!-- Period selector -->
  <div class="periods" id="periods"></div>

  <!-- Main content -->
  <div class="content" id="content"></div>

  <!-- Bottom navigation -->
  <div class="bottom-nav">
    <button class="nav-item active" data-view="chart">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
      <span>Chart</span>
      <div class="indicator"></div>
    </button>
    <button class="nav-item" data-view="prices">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3A8.994 8.994 0 0013 3.06V2c0-.55-.45-1-1-1s-1 .45-1 1v1.06A8.994 8.994 0 003.06 11H2c-.55 0-1 .45-1 1s.45 1 1 1h1.06A8.994 8.994 0 0011 20.94V22c0 .55.45 1 1 1s1-.45 1-1v-1.06A8.994 8.994 0 0020.94 13H22c.55 0 1-.45 1-1s-.45-1-1-1h-1.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/></svg>
      <span>Prices</span>
    </button>
    <button class="nav-item" data-view="compare">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
      <span>Compare</span>
    </button>
    <button class="nav-item" data-view="history">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l2 2m-2-6V4m0 16v-4m6-6h4m-16 0H4m6 6h4"/></svg>
      <span>History</span>
    </button>
  </div>
</div>

<canvas id="chartCanvas" style="display:none;"></canvas>

<script>
  // ==== State ====
  let referenceCurrency = 'chaos';
  let selectedPeriod = '1D';
  let viewMode = 'chart';
  let selectedCurrency = null;
  let currencies = [];

  const TIME_PERIODS = ['1D','3D','1W','1M'];
  const VIEWS = ['chart','prices','compare','history'];

  // ==== Sample fallback data (only a few items for demo) ====
  const sampleData = [
    {id:"divine",name:"Divine Orb",icon:"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvRHZpbmVPcmIiLCJ3IjoyLCJoIjoyLCJzY2FsZSI6MX1d/2e4f3c3c3c/DivineOrb.png",currentPrice:182,referenceCurrency:"chaos",change1d:3.2,change3d:7.1,change1w:-2.4,change1m:15.8,priceHistory:[{timestamp:"2025-12-06",value:168},{timestamp:"2025-12-07",value:170},{timestamp:"2025-12-08",value:174},{timestamp:"2025-12-09",value:176},{timestamp:"2025-12-10",value:174},{timestamp:"2025-12-11",value:178},{timestamp:"2025-12-12",value:182}]},
    {id:"exalted",name:"Exalted Orb",icon:"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvRXhhbHRlZE9yYiIsInciOjEsImgiOjEsInNjYWxlIjoxfV0/8c3c3c3c3c/ExaltedOrb.png",currentPrice:12.4,referenceCurrency:"chaos",change1d:-1.1,change3d:2.8,change1w:8.9,change1m:22.3,priceHistory:[{timestamp:"2025-12-06",value:11.8},{timestamp:"2025-12-07",value:12},{timestamp:"2025-12-08",value:12.1},{timestamp:"2025-12-09",value:12.3},{timestamp:"2025-12-10",value:12.5},{timestamp:"2025-12-11",value:12.4},{timestamp:"2025-12-12",value:12.4}]},
    {id:"mirror",name:"Mirror of Kalandra",icon:"https://web.poecdn.com/gen/image/WzI1LDE0LHsiZiI6IjJESXRlbXMvQ3VycmVuY3kvTWlycm9yIiwidyI6MSwiaCI6Miwic2NhbGUiOjF9XQ/3c3c3c3c3c/Mirror.png",currentPrice:24000,referenceCurrency:"chaos",change1d:0.8,change3d:-3.2,change1w:12.5,change1m:31.2,priceHistory:[{timestamp:"2025-12-06",value:23500},{timestamp:"2025-12-07",value:23700},{timestamp:"2025-12-08",value:23800},{timestamp:"2025-12-09",value:23900},{timestamp:"2025-12-10",value:24100},{timestamp:"2025-12-11",value:24000},{timestamp:"2025-12-12",value:24000}]},
  ];

  // ==== API ====
  async function fetchData(ref) {
    try {
      const url = `https://poe2scout.com/api/items/currency/currency?page=1&perPage=30&league=Rise%20of%20the%20Abyssal&referenceCurrency=${ref}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("API error");
      const json = await res.json();
      return json.items.map(item => {
        const price = ref === 'chaos' ? (item.chaosEquivalent||0) : (item.exaltedEquivalent||0);
        const change = (item.sparkline?.totalChange||0);
        const history = [];
        const now = Date.now();
        for(let i=6;i>=0;i--){
          const d = new Date(now - i*24*60*60*1000);
          const factor = 1 + (change/100)*(i/6);
          history.push({timestamp:d.toISOString().slice(0,10), value:Math.round(price/factor*100)/100});
        }
        return {
          id: item.id,
          name: item.name,
          icon: item.icon,
          currentPrice: price,
          referenceCurrency: ref,
          change1d: Math.round(change*0.15*10)/10,
          change3d: Math.round(change*0.4*10)/10,
          change1w: Math.round(change*10)/10,
          change1m: Math.round(change*1.5*10)/10,
          priceHistory: history.reverse()
        };
      });
    } catch(e) {
      console.warn("API failed, using sample data", e);
      return sampleData;
    }
  }

  // ==== Render helpers ====
  function getChange(currency, period){
    switch(period){
      case '1D': return currency.change1d;
      case '3D': return currency.change3d;
      case '1W': return currency.change1w;
      case '1M': return currency.change1m;
      default: return currency.change1d;
    }
  }

  function renderChart(){
    const canvas = document.getElementById('chartCanvas');
    canvas.width = canvas.parentNode.offsetWidth;
    canvas.height = 200;
    canvas.style.display = 'block';
    const ctx = canvas.getContext('2d');
    const data = selectedCurrency.priceHistory;
    const labels = data.map(p=>p.timestamp.slice(5));
    const values = data.map(p=>p.value);
    const positive = getChange(selectedCurrency,'1D') >= 0;
    const color = positive ? '#34c97a' : '#ef4444';

    new Chart(ctx, {
      type:'line',
      data:{ labels, datasets:[{ data:values, borderColor:color, backgroundColor:color+'20', fill:true, tension:0.4, pointRadius:4, pointHoverRadius:6 }] },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        plugins:{legend:{display:false}, tooltip:{backgroundColor:'rgba(0,0,0,0.8)', titleColor:'#fff', bodyColor:'#fff'}},
        scales:{ x:{grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#aaa'}}, y:{grid:{color:'rgba(255,255,255,0.05)'}, ticks:{color:'#aaa'}} }
      }
    });
  }

  function renderContent(){
    const el = document.getElementById('content');
    let html = '';

    if(viewMode === 'chart'){
      html = `
        <div class="fade-in">
          <div class="chart-header">
            <div class="chart-title">
              <img src="${selectedCurrency.icon}" alt="${selectedCurrency.name}">
              <div>
                <h2>${selectedCurrency.name}</h2>
                <div class="chart-price">${selectedCurrency.currentPrice.toLocaleString()} ${selectedCurrency.referenceCurrency}</div>
              </div>
            </div>
            <div class="change-badge ${getChange(selectedCurrency,'1D')>=0?'positive':'negative'}">
              ${getChange(selectedCurrency,'1D')>=0?'+':''}${getChange(selectedCurrency,'1D').toFixed(1)}%
            </div>
          </div>
          <canvas id="chartCanvas"></canvas>
        </div>`;
    }
    else if(viewMode === 'prices'){
      html = `<div class="fade-in price-list">
        ${currencies.map(c=> {
          const ch = getChange(c,selectedPeriod);
          const pos = ch>=0;
          const sel = selectedCurrency.id===c.id;
          return `<div class="price-card ${sel?'selected':''}" onclick="selectCurrency('${c.id}')">
            <div class="price-row">
              <div class="price-info">
                <img src="${c.icon}" alt="${c.name}">
                <div>
                  <div class="price-name">${c.name}</div>
                  <div class="price-val">${c.currentPrice.toLocaleString()} ${c.referenceCurrency}</div>
                </div>
              </div>
              <div style="display:flex;align-items:center;gap:4px;color:${pos?'#34c97a':'#ef4444'};font-weight:600;">
                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="${pos?'M5 15l7-7 7 7':'M19 9l-7 7-7-7'}"/></svg>
                ${pos?'+':''}${ch.toFixed(1)}%
              </div>
            </div>
          </div>`;
        }).join('')}
      </div>`;
    }
    else if(viewMode === 'compare'){
      html = `<div class="fade-in compare-grid">
        ${currencies.slice(0,12).map(c=> `
          <div class="compare-card" onclick="selectCurrency('${c.id}')">
            <div class="compare-name">
              <img src="${c.icon}" alt="${c.name}">
              <span>${c.name}</span>
            </div>
            <div class="compare-price">${c.currentPrice.toLocaleString()}</div>
            <div class="compare-changes">
              <div style="color:${c.change1d>=0?'#34c97a':'#ef4444'}">1D ${c.change1d>=0?'+' :''}${c.change1d}%</div>
              <div style="color:${c.change3d>=0?'#34c97a':'#ef4444'}">3D ${c.change3d>=0?'+' :''}${c.change3d}%</div>
              <div style="color:${c.change1w>=0?'#34c97a':'#ef4444'}">1W ${c.change1w>=0?'+' :''}${c.change1w}%</div>
              <div style="color:${c.change1m>=0?'#34c97a':'#ef4444'}">1M ${c.change1m>=0?'+' :''}${c.change1m}%</div>
            </div>
          </div>`).join('')}
      </div>`;
    }
    else if(viewMode === 'history'){
      html = `<div class="fade-in history-list">
        ${selectedCurrency.priceHistory.slice().reverse().map(p=>`
          <div class="history-item">
            <span>${p.timestamp}</span>
            <span style="font-weight:600">${p.value.toLocaleString()} ${selectedCurrency.referenceCurrency}</span>
          </div>
        `).join('')}
      </div>`;
    }

    el.innerHTML = html;
    if(viewMode==='chart') setTimeout(renderChart,50);
  }

  // ==== Actions ====
  function selectCurrency(id){
    selectedCurrency = currencies.find(c=>c.id===id) || currencies[0];
    renderContent();
  }
  async function setReference(ref){
    referenceCurrency = ref;
    document.querySelectorAll('.ref-btn').forEach(b=>b.classList.toggle('active', b.id===ref+'Btn'));
    currencies = await fetchData(ref);
    selectedCurrency = currencies[0];
    renderContent();
  }
  function setPeriod(p){
    selectedPeriod = p;
    document.querySelectorAll('.period-btn').forEach(b=>b.classList.toggle('active', b.dataset.period===p));
    renderContent();
  }
  function setView(v){
    viewMode = v;
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.toggle('active', n.dataset.view===v));
    document.querySelectorAll('.indicator').forEach(i=>i.remove());
    document.querySelector(`.nav-item[data-view="${v}"]`).insertAdjacentHTML('beforeend','<div class="indicator"></div>');
    renderContent();
  }
  async function refresh(){
    currencies = await fetchData(referenceCurrency);
    selectedCurrency = currencies.find(c=>c.id===selectedCurrency.id) || currencies[0];
    renderContent();
  }

  // ==== Init ====
  async function init(){
    // reference buttons
    document.getElementById('chaosBtn').classList.add('active');
    document.getElementById('chaosBtn').onclick = ()=>setReference('chaos');
    document.getElementById('exaltedBtn').onclick = ()=>setReference('exalted');
    document.getElementById('refreshBtn').onclick = refresh;

    // period buttons
    const periodsEl = document.getElementById('periods');
    TIME_PERIODS.forEach(p=>{
      const btn = document.createElement('button');
      btn.className='period-btn';
      btn.textContent=p;
      btn.dataset.period=p;
      btn.onclick=()=>setPeriod(p);
      if(p==='1D') btn.classList.add('active');
      periodsEl.appendChild(btn);
    });

    // nav buttons
    document.querySelectorAll('.nav-item').forEach(n=>n.onclick=()=>setView(n.dataset.view));

    // first load
    currencies = await fetchData('chaos');
    selectedCurrency = currencies[0];
    renderContent();
  }

  // expose for onclick
  window.selectCurrency = selectCurrency;
  init();
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>